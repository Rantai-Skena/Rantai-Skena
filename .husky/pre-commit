#!/bin/sh
set -e

# No staged files -> nothing to do
if [ -z "$(git diff --cached --name-only)" ]; then
  echo "No staged files to format"
  exit 0
fi

# Hash staged diff before formatting (for info message)
STAGED_HASH=$(git diff --cached | sha256sum | cut -d' ' -f1)

# List staged files we care about
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

# Create a unique stash name so we only pop what we created
STASH_NAME="pre-commit-stash-$(date +%s)"

# Stash unstaged + untracked changes, keep index (staged changes stay)
set +e
git stash push -u -k -q -m "$STASH_NAME"
set -e

# Detect whether stash was actually created
STASH_CREATED=0
if git stash list | grep -q "$STASH_NAME"; then
  STASH_CREATED=1
fi

# Run formatter (capture exit code, don't let set -e kill the script)
set +e
pnpm dlx ultracite fix
FORMAT_EXIT_CODE=$?
set -e

# If formatter failed: revert formatter changes for staged files,
# then restore unstaged changes from OUR stash, and exit non-zero.
if [ $FORMAT_EXIT_CODE -ne 0 ]; then
  echo "❌ Ultracite failed. Restoring your working tree..."

  if [ -n "$STAGED_FILES" ]; then
    printf '%s\n' "$STAGED_FILES" | while IFS= read -r file; do
      if [ -f "$file" ]; then
        # Restore working tree from index (undo formatter edits, keep staged state)
        git restore --worktree "$file"
      fi
    done
  fi

  if [ $STASH_CREATED -eq 1 ]; then
    git stash pop -q || true
  fi

  exit $FORMAT_EXIT_CODE
fi

# Formatter success -> stage formatted versions of staged files
if [ -n "$STAGED_FILES" ]; then
  printf '%s\n' "$STAGED_FILES" | while IFS= read -r file; do
    if [ -f "$file" ]; then
      git add "$file"
    fi
  done
fi

# Restore unstaged changes (only if we created a stash)
if [ $STASH_CREATED -eq 1 ]; then
  git stash pop -q || {
    echo "⚠️  Could not automatically re-apply unstaged changes."
    echo "They are still in your stash:"
    git stash list | head -n 1
  }
fi

# Inform if staged content changed by formatting
NEW_STAGED_HASH=$(git diff --cached | sha256sum | cut -d' ' -f1)
if [ "$STAGED_HASH" != "$NEW_STAGED_HASH" ]; then
  echo "✨ Files formatted by Ultracite"
fi

exit 0
